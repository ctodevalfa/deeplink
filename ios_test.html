<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS Deeplink Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            background: #007AFF;
            color: white;
            text-decoration: none;
            text-align: center;
        }
        .btn:active {
            background: #0056CC;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>üß™ iOS Deeplink Test</h1>
    <p>–¢–µ—Å—Ç –±—ã—Å—Ç—Ä—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –¥–ª—è iOS –°–±–µ—Ä</p>
    
    <div id="status" class="status info">–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é</div>
    
    <button class="btn" onclick="testSberSchemes()">–¢–µ—Å—Ç –≤—Å–µ—Ö —Å—Ö–µ–º –°–±–µ—Ä–∞</button>
    <button class="btn" onclick="testSingleScheme('sberbankonline')">–¢–µ—Å—Ç sberbankonline</button>
    <button class="btn" onclick="testSingleScheme('sbolonline')">–¢–µ—Å—Ç sbolonline</button>
    <button class="btn" onclick="testSingleScheme('iosappsmartonline')">–¢–µ—Å—Ç iosappsmartonline</button>
    <button class="btn" onclick="testSingleScheme('budgetonline')">–¢–µ—Å—Ç budgetonline</button>
    <button class="btn" onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    
    <div id="log" class="log"></div>

    <script>
        let testInProgress = false;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function setStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function testSingleScheme(scheme) {
            if (testInProgress) {
                log('‚ùå –¢–µ—Å—Ç —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏—Ç–µ');
                return;
            }
            
            testInProgress = true;
            setStatus(`–¢–µ—Å—Ç–∏—Ä—É–µ–º —Å—Ö–µ–º—É ${scheme}...`, 'info');
            
            const testPhone = '79991234567';
            const testAmount = 100;
            const url = `${scheme}://payments/p2p-by-phone-number?phoneNumber=${testPhone}`;
            
            log(`üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º: ${url}`);
            
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è
            let appOpened = false;
            const startTime = Date.now();
            
            const handleVisibilityChange = () => {
                if (document.hidden && !appOpened) {
                    appOpened = true;
                    const elapsed = Date.now() - startTime;
                    log(`‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å! –í—Ä–µ–º—è: ${elapsed}ms`);
                    setStatus(`–°—Ö–µ–º–∞ ${scheme} —Ä–∞–±–æ—Ç–∞–µ—Ç!`, 'success');
                    cleanup();
                    testInProgress = false;
                }
            };
            
            const handleBeforeUnload = () => {
                if (!appOpened) {
                    appOpened = true;
                    log(`‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å (beforeunload)!`);
                    setStatus(`–°—Ö–µ–º–∞ ${scheme} —Ä–∞–±–æ—Ç–∞–µ—Ç!`, 'success');
                    testInProgress = false;
                }
            };
            
            const cleanup = () => {
                document.removeEventListener('visibilitychange', handleVisibilityChange);
                window.removeEventListener('beforeunload', handleBeforeUnload);
                window.removeEventListener('pagehide', handleBeforeUnload);
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('beforeunload', handleBeforeUnload);
            window.addEventListener('pagehide', handleBeforeUnload);
            
            // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥
            try {
                window.location.href = url;
                
                // –ï—Å–ª–∏ —á–µ—Ä–µ–∑ 500ms –º—ã –≤—Å–µ –µ—â–µ –∑–¥–µ—Å—å, —Å—Ö–µ–º–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞
                setTimeout(() => {
                    if (!appOpened) {
                        const elapsed = Date.now() - startTime;
                        log(`‚ùå –°—Ö–µ–º–∞ ${scheme} –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞. –í—Ä–µ–º—è: ${elapsed}ms`);
                        setStatus(`–°—Ö–µ–º–∞ ${scheme} –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç`, 'error');
                        cleanup();
                        testInProgress = false;
                    }
                }, 500);
                
            } catch (e) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ ${scheme}: ${e.message}`);
                setStatus(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ ${scheme}`, 'error');
                cleanup();
                testInProgress = false;
            }
        }
        
        function testSberSchemes() {
            if (testInProgress) {
                log('‚ùå –¢–µ—Å—Ç —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏—Ç–µ');
                return;
            }
            
            const schemes = [
                'sberbankonline',
                'sbolonline', 
                'iosappsmartonline',
                'budgetonline',
                'btripsexpenses'
            ];
            
            let currentIndex = 0;
            testInProgress = true;
            
            function testNextScheme() {
                if (currentIndex >= schemes.length) {
                    log('üèÅ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ö–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                    setStatus('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ', 'info');
                    testInProgress = false;
                    return;
                }
                
                const scheme = schemes[currentIndex++];
                const testPhone = '79991234567';
                const url = `${scheme}://payments/p2p-by-phone-number?phoneNumber=${testPhone}`;
                
                log(`üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å—Ö–µ–º—É ${currentIndex}/${schemes.length}: ${scheme}`);
                setStatus(`–¢–µ—Å—Ç–∏—Ä—É–µ–º ${scheme} (${currentIndex}/${schemes.length})...`, 'info');
                
                let appOpened = false;
                const startTime = Date.now();
                
                const handleVisibilityChange = () => {
                    if (document.hidden && !appOpened) {
                        appOpened = true;
                        const elapsed = Date.now() - startTime;
                        log(`‚úÖ –°—Ö–µ–º–∞ ${scheme} —Ä–∞–±–æ—Ç–∞–µ—Ç! –í—Ä–µ–º—è: ${elapsed}ms`);
                        setStatus(`–ù–∞–π–¥–µ–Ω–∞ —Ä–∞–±–æ—á–∞—è —Å—Ö–µ–º–∞: ${scheme}!`, 'success');
                        cleanup();
                        testInProgress = false;
                        return; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —É—Å–ø–µ—Ö–µ
                    }
                };
                
                const handleBeforeUnload = () => {
                    if (!appOpened) {
                        appOpened = true;
                        log(`‚úÖ –°—Ö–µ–º–∞ ${scheme} —Ä–∞–±–æ—Ç–∞–µ—Ç (beforeunload)!`);
                        setStatus(`–ù–∞–π–¥–µ–Ω–∞ —Ä–∞–±–æ—á–∞—è —Å—Ö–µ–º–∞: ${scheme}!`, 'success');
                        testInProgress = false;
                        return;
                    }
                };
                
                const cleanup = () => {
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                    window.removeEventListener('beforeunload', handleBeforeUnload);
                    window.removeEventListener('pagehide', handleBeforeUnload);
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                document.addEventListener('visibilitychange', handleVisibilityChange);
                window.addEventListener('beforeunload', handleBeforeUnload);
                window.addEventListener('pagehide', handleBeforeUnload);
                
                // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥
                try {
                    window.location.href = url;
                    
                    // –ï—Å–ª–∏ —á–µ—Ä–µ–∑ 300ms –º—ã –≤—Å–µ –µ—â–µ –∑–¥–µ—Å—å, –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â—É—é —Å—Ö–µ–º—É
                    setTimeout(() => {
                        if (!appOpened) {
                            const elapsed = Date.now() - startTime;
                            log(`‚ùå –°—Ö–µ–º–∞ ${scheme} –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞. –í—Ä–µ–º—è: ${elapsed}ms`);
                            cleanup();
                            testNextScheme(); // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ö–µ–º–µ
                        }
                    }, 300);
                    
                } catch (e) {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ ${scheme}: ${e.message}`);
                    cleanup();
                    testNextScheme();
                }
            }
            
            testNextScheme();
        }
        
        // –î–µ—Ç–µ–∫—Ü–∏—è iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        if (!isIOS) {
            setStatus('‚ö†Ô∏è –≠—Ç–æ—Ç —Ç–µ—Å—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è iOS —É—Å—Ç—Ä–æ–π—Å—Ç–≤', 'error');
            log('‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–µ-iOS —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ. –¢–µ—Å—Ç –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.');
        } else {
            log('‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ iOS —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ');
            setStatus('iOS —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!', 'success');
        }
    </script>
</body>
</html> 