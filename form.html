<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <title>Deeplink Generator</title>
  <style>
    :root {
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --border: #e1e8ed;
      --text: #14171a;
      --text-muted: #5b7083;
      --primary: #1da1f2;
      --primary-hover: #1991db;
      --success: #17bf63;
      --radius: 20px;
      --radius-sm: 12px;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
      --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.18);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 20px;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding-top: 40px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      width: 100%;
      max-width: 440px;
      padding: 40px 32px;
      box-shadow: var(--shadow-xl);
      position: relative;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, var(--primary), var(--success));
      border-radius: var(--radius) var(--radius) 0 0;
    }

    h1 {
      font-size: 26px;
      font-weight: 700;
      margin: 0 0 28px;
      text-align: center;
      color: var(--text);
      letter-spacing: -0.02em;
      line-height: 1.2;
    }

    .field-group {
      margin-bottom: 20px;
    }

    .field-label {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      display: block;
      color: var(--text);
      letter-spacing: -0.01em;
    }

    input, select {
      width: 100%;
      padding: 16px 20px;
      font-size: 16px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      background: #fff;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
      font-weight: 500;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(29, 161, 242, 0.1);
      transform: translateY(-1px);
    }

    input::placeholder {
      color: var(--text-muted);
      font-weight: 400;
    }

    input:disabled, select:disabled {
      background: #f8f9fa;
      color: #6c757d;
      border-color: #e9ecef;
      cursor: not-allowed;
    }

    input:disabled::placeholder {
      color: #adb5bd;
    }

    /* checkbox component */
    .checkbox-wrapper {
      margin: 20px 0 28px;
    }
    
    .checkbox-container {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
      position: relative;
      padding: 12px 16px;
      border-radius: 12px;
      transition: background-color 0.2s ease;
    }
    
    .checkbox-container:hover {
      background-color: #f8fafc;
    }
    
    .checkbox-container input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin: 0;
      margin-right: 12px;
      cursor: pointer;
      accent-color: var(--primary);
      transform: scale(1.1);
    }
    
    .checkbox-container span {
      font-size: 15px;
      color: var(--text);
      line-height: 1.4;
      font-weight: 500;
    }

    #generate-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
      color: #fff;
      border: none;
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 700;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-lg);
      letter-spacing: -0.01em;
      position: relative;
      overflow: hidden;
    }

    #generate-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    #generate-btn:hover::before {
      left: 100%;
    }

    #generate-btn:hover { 
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }

    #generate-btn:active {
      transform: translateY(0);
    }

    .banks {
      margin-top: 32px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
    }

    .bank-btn {
      padding: 0;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow);
      overflow: hidden;
      background: #fff;
      width: 100%;
      height: 64px;
      position: relative;
      display: block;
    }

    .bank-btn:hover { 
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary);
    }

    .bank-btn:active {
      transform: translateY(0);
    }

    .bank-btn object {
      width: 100%;
      height: 100%;
      display: block;
      pointer-events: none;
      border-radius: var(--radius-sm);
      object-fit: contain;
      padding: 8px;
    }

    .hints-container {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .hint {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 12px;
      text-align: center;
      font-weight: 500;
      line-height: 1.4;
    }

    .hint:last-child {
      margin-bottom: 0;
    }

    .hint-small {
      font-size: 12px;
      color: #999;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    code {
      background: #f1f3f4;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-size: 11px;
      color: #333;
      white-space: nowrap;
      margin: 0 2px;
    }

    @media (max-width: 480px) {
      body {
        padding: 16px;
        padding-top: 20px;
      }
      
      .card {
        padding: 32px 24px;
        max-width: 100%;
        border-radius: var(--radius-sm);
      }
      
      .banks {
        grid-template-columns: 1fr;
        gap: 16px;
        margin-top: 24px;
      }
      
      .bank-btn {
        height: 56px;
      }
      
      h1 {
        font-size: 24px;
        margin-bottom: 24px;
      }
      
      input, select {
        padding: 14px 16px;
        font-size: 16px;
      }
      
      .field-group {
        margin-bottom: 16px;
      }
      
      .hints-container {
        margin-top: 20px;
        padding-top: 16px;
      }
      
      .hint {
        font-size: 12px;
      }
      
      .hint-small {
        font-size: 11px;
        line-height: 1.3;
      }
      
      code {
        font-size: 10px;
        padding: 1px 4px;
        margin: 0 1px;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1 id="form-title">–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã –æ–ø–ª–∞—Ç—ã</h1>

    <div class="field-group">
      <label class="field-label" for="purpose">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞</label>
      <input id="purpose" type="text" placeholder="–û–ø–ª–∞—Ç–∞ —É—Å–ª—É–≥, —Ç–æ–≤–∞—Ä–æ–≤..." />
    </div>

    <div class="field-group">
      <label class="field-label" for="account">–¢–µ–ª–µ—Ñ–æ–Ω ¬´+7‚Ä¶¬ª –∏–ª–∏ ‚Ññ –∫–∞—Ä—Ç—ã</label>
      <input id="account" type="text" placeholder="+7 999 123-45-67" />
    </div>

    <div class="field-group">
      <label class="field-label" for="amount">–°—É–º–º–∞, ‚ÇΩ</label>
      <input id="amount" type="number" step="0.01" placeholder="1000.00" />
    </div>

    <div class="field-group">
      <label class="field-label" for="tinkoff-member">bankMemberId (Tinkoff)</label>
      <select id="tinkoff-member">
        <option value="10076">10076 ‚Äì –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
        <option value="10075">10075</option>
        <option value="10074">10074</option>
      </select>
    </div>

    <div class="checkbox-wrapper">
      <label class="checkbox-container" for="transborder">
        <input id="transborder" type="checkbox" />
        <span>–¢—Ä–∞–Ω—Å–≥—Ä–∞–Ω–∏—á–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥</span>
      </label>
    </div>

    <button id="generate-btn">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å deeplink-–∫–Ω–æ–ø–∫–∏</button>

    <button id="copy-link-btn" style="margin-top: 8px; padding: 8px 16px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; color: #6c757d; font-size: 14px; cursor: pointer; display: none;">
      üîí –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å read-only —Å—Å—ã–ª–∫—É
    </button>

    <div class="banks" id="banks"></div>
    
    <button id="clear-preferences" style="margin-top: 12px; padding: 8px 16px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 8px; color: #666; font-size: 13px; cursor: pointer; display: none;">
      –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
    </button>
    
    <div class="hints-container">
      <div class="hint" id="device-hint">–ó–∞–ø—É—Å–∫ deeplink-–æ–≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —á–µ—Ä–µ–∑ HTTP-—Å–µ—Ä–≤–µ—Ä.</div>
      
      <div class="hint hint-small">
        üí° URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: <code>purpose</code>, <code>phone</code>, <code>amount</code>, <code>bankMemberId</code>, <code>transborder</code>, <code>disable</code>
      </div>
    </div>
  </div>

  <script type="module">
    import { generateDeepLinks, generateDesktopLink, buildQrUrl } from './deep.js';

    const BANKS = {
      ru_tinkoff: { label: 'T-Pay', css: 'tinkoff', icon: './tpaybutton.svg' },
      ru_sberbank: { label: 'SberPay', css: 'sber', icon: './sber_pay.svg' },
      ru_vtb: { label: 'VTB Pay', css: 'vtb', icon: './vtb_logo.svg' }
    };

    const $purpose = document.getElementById('purpose');
    const $account = document.getElementById('account');
    const $amount = document.getElementById('amount');
    const $tinkoffMember = document.getElementById('tinkoff-member');
    const $transborder = document.getElementById('transborder');
    const $banksWrap = document.getElementById('banks');
    const $clearBtn = document.getElementById('clear-preferences');
    const $hint = document.getElementById('device-hint');
    const $copyLinkBtn = document.getElementById('copy-link-btn');
    const $formTitle = document.getElementById('form-title');

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    function getDeviceInfo() {
      const ua = navigator.userAgent;
      const isIOS = /iPhone|iPad|iPod/i.test(ua);
      const isAndroid = /Android/i.test(ua);
      const isMobile = isIOS || isAndroid || /Mobile|Tablet/i.test(ua);
      
      return {
        isIOS,
        isAndroid,
        isMobile,
        platform: isIOS ? 'ios' : isAndroid ? 'android' : 'desktop'
      };
    }

    // –†–∞–±–æ—Ç–∞ —Å –∫—É–∫–∏
    function setCookie(name, value, days = 30) {
      const expires = new Date();
      expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
      document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
    }

    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    // –ò–∑–≤–ª–µ—á—å —Å—Ö–µ–º—É –∏–∑ —Å—Å—ã–ª–∫–∏ (–±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)
    function extractSchemePattern(link) {
      // –î–ª—è –°–±–µ—Ä–∞ –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—Ö–µ–º—É –∏ –±–∞–∑–æ–≤—ã–π –ø—É—Ç—å
      if (link.includes('sbolonline://') || link.includes('sberbankonline://') || 
          link.includes('budgetonline-ios://') || link.includes('ios-app-smartonline://') ||
          link.includes('app-online-ios://') || link.includes('btripsexpenses://')) {
        
        // –£–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Ö–µ–º—É –∏ –ø—É—Ç—å
        const match = link.match(/^([^:]+:\/\/[^?]+)/);
        return match ? match[1] : link;
      }
      
      // –î–ª—è –¢–∏–Ω—å–∫–æ—Ñ—Ñ –∏ –¥—Ä—É–≥–∏—Ö –±–∞–Ω–∫–æ–≤ —Ç–æ–∂–µ —É–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
      if (link.includes('://')) {
        const match = link.match(/^([^:]+:\/\/[^?]+)/);
        return match ? match[1] : link;
      }
      
      // –î–ª—è –¥—Ä—É–≥–∏—Ö –±–∞–Ω–∫–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
      return link;
    }

    // –ù–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â—É—é —Å—Å—ã–ª–∫—É –ø–æ —Å—Ö–µ–º–µ
    function findLinkByScheme(links, schemePattern) {
      return links.find(link => {
        const linkScheme = extractSchemePattern(link);
        return linkScheme === schemePattern;
      });
    }

    // –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—É—é —Å—Ö–µ–º—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –±–∞–Ω–∫–∞ –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    function getPreferredScheme(bank) {
      const device = getDeviceInfo();
      const cookieName = `preferred_scheme_${bank}_${device.platform}`;
      return getCookie(cookieName);
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—Å–ø–µ—à–Ω—É—é —Å—Ö–µ–º—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –±–∞–Ω–∫–∞ –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    function savePreferredScheme(bank, link) {
      const device = getDeviceInfo();
      const cookieName = `preferred_scheme_${bank}_${device.platform}`;
      const scheme = extractSchemePattern(link);
      setCookie(cookieName, scheme);
      console.log(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –¥–ª—è ${bank} –Ω–∞ ${device.platform}:`, scheme);
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å QR-–∫–æ–¥ –¥–ª—è desktop
    function showQrCode(params) {
      const qrUrl = buildQrUrl({
        phone: params.phone,
        amount: params.amount,
        bankMemberId: params.bankMemberId
      });

      // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å QR-–∫–æ–¥–æ–º
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      `;

      modal.innerHTML = `
        <div style="background: white; padding: 32px; border-radius: 16px; text-align: center; max-width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
          <h3 style="margin: 0 0 16px 0; color: #333;">QR-–∫–æ–¥ –¥–ª—è –æ–ø–ª–∞—Ç—ã</h3>
          <div style="margin: 20px 0;">
            <div id="qr-container" style="display: flex; justify-content: center; margin: 20px 0;">
              <div style="width: 200px; height: 200px; border: 2px dashed #ddd; display: flex; align-items: center; justify-content: center; color: #666;">
                –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞...
              </div>
            </div>
          </div>
          <p style="color: #666; font-size: 14px; margin: 16px 0;">
            –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –≤ –º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –±–∞–Ω–∫–∞
          </p>
          <button id="close-qr" style="background: #007AFF; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px;">
            –ó–∞–∫—Ä—ã—Ç—å
          </button>
          <div style="margin-top: 12px;">
            <a href="${qrUrl}" target="_blank" style="color: #007AFF; text-decoration: none; font-size: 14px;">
              –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞–ø—Ä—è–º—É—é
            </a>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR-–∫–æ–¥
      generateQrCode(qrUrl, modal.querySelector('#qr-container'));

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
      modal.querySelector('#close-qr').onclick = () => modal.remove();
      modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
      };
    }

    // –ü—Ä–æ—Å—Ç–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞ —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å
    function generateQrCode(url, container) {
      const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
      
      const img = document.createElement('img');
      img.src = qrApiUrl;
      img.style.cssText = 'width: 200px; height: 200px; border-radius: 8px;';
      img.onload = () => {
        container.innerHTML = '';
        container.appendChild(img);
      };
      img.onerror = () => {
        container.innerHTML = `
          <div style="padding: 20px; color: #666;">
            <p>–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞</p>
            <p style="font-size: 12px; word-break: break-all;">${url}</p>
          </div>
        `;
      };
    }

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å—Ö–µ–º—ã –¥–ª—è –ª—é–±–æ–≥–æ –±–∞–Ω–∫–∞
    function hasAnyPreferredSchemes() {
      const device = getDeviceInfo();
      return Object.keys(BANKS).some(bank => {
        const cookieName = `preferred_scheme_${bank}_${device.platform}`;
        return getCookie(cookieName) !== null;
      });
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    function updateDeviceHint() {
      const device = getDeviceInfo();
      if (device.platform === 'desktop') {
        $hint.textContent = '–ù–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ: –í–¢–ë –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω QR-–∫–æ–¥.';
      } else if (device.isIOS) {
        $hint.textContent = '–ù–∞ iOS: deeplink-—ã –±—É–¥—É—Ç –ø—ã—Ç–∞—Ç—å—Å—è –æ—Ç–∫—Ä—ã—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.';
      } else if (device.isAndroid) {
        $hint.textContent = '–ù–∞ Android: deeplink-—ã –±—É–¥—É—Ç –ø—ã—Ç–∞—Ç—å—Å—è –æ—Ç–∫—Ä—ã—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.';
      } else {
        $hint.textContent = '–ó–∞–ø—É—Å–∫ deeplink-–æ–≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —á–µ—Ä–µ–∑ HTTP-—Å–µ—Ä–≤–µ—Ä.';
      }
    }

    // –†–∞–±–æ—Ç–∞ —Å URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        purpose: params.get('purpose') || '',
        phone: params.get('phone') || params.get('account') || '',
        amount: params.get('amount') || '',
        bankMemberId: params.get('bankMemberId') || params.get('member') || '10076',
        transborder: params.get('transborder') === 'true' || params.get('transborder') === '1',
        disable: params.get('disable') === 'true' || params.get('disable') === '1'
      };
    }

    function updateUrlParams() {
      const params = new URLSearchParams();
      
      const purpose = $purpose.value.trim();
      const phone = $account.value.trim();
      const amount = $amount.value.trim();
      const bankMemberId = $tinkoffMember.value;
      const transborder = $transborder.checked;

      if (purpose) params.set('purpose', purpose);
      if (phone) params.set('phone', phone);
      if (amount) params.set('amount', amount);
      if (bankMemberId !== '10076') params.set('bankMemberId', bankMemberId);
      if (transborder) params.set('transborder', 'true');

      const newUrl = params.toString() ? 
        `${window.location.pathname}?${params.toString()}` : 
        window.location.pathname;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      window.history.replaceState({}, '', newUrl);

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
      updateCopyLinkButton(phone, amount);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ
      if (!getUrlParams().disable) {
        updateFormTitle({ disable: false, purpose: purpose });
      }
    }

    function updateCopyLinkButton(phone, amount) {
      if (phone && amount) {
        $copyLinkBtn.style.display = 'block';
      } else {
        $copyLinkBtn.style.display = 'none';
      }
    }

    async function copyCurrentLink() {
      // –°–æ–∑–¥–∞–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º disable=true
      const url = new URL(window.location.href);
      url.searchParams.set('disable', 'true');
      const disabledUrl = url.toString();
      
      try {
        await navigator.clipboard.writeText(disabledUrl);
        
        // –í—Ä–µ–º–µ–Ω–Ω–æ –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
        const originalText = $copyLinkBtn.textContent;
        $copyLinkBtn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        $copyLinkBtn.style.background = '#d4edda';
        $copyLinkBtn.style.color = '#155724';
        
        setTimeout(() => {
          $copyLinkBtn.textContent = originalText;
          $copyLinkBtn.style.background = '#f8f9fa';
          $copyLinkBtn.style.color = '#6c757d';
        }, 2000);
        
        console.log('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞:', disabledUrl);
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
        
        // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        const textArea = document.createElement('textarea');
        textArea.value = disabledUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        $copyLinkBtn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        setTimeout(() => {
          $copyLinkBtn.textContent = 'üîí –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å read-only —Å—Å—ã–ª–∫—É';
        }, 2000);
      }
    }

    function fillFormFromUrl() {
      const params = getUrlParams();
      
      if (params.purpose) {
        $purpose.value = params.purpose;
      }
      if (params.phone) {
        $account.value = params.phone;
      }
      if (params.amount) {
        $amount.value = params.amount;
      }
      if (params.bankMemberId) {
        $tinkoffMember.value = params.bankMemberId;
      }
      if (params.transborder) {
        $transborder.checked = params.transborder;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
      updateFormTitle(params);

      // –ü—Ä–∏–º–µ–Ω—è–µ–º disabled —Ä–µ–∂–∏–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      if (params.disable) {
        applyDisabledMode();
      }

      // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
      if (params.phone && params.amount) {
        console.log('–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:', params);
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        setTimeout(() => {
          document.getElementById('generate-btn').click();
        }, 100);
      }
    }

    function updateFormTitle(params) {
      if (params.disable && params.purpose) {
        // Read-only —Ä–µ–∂–∏–º —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º –ø–ª–∞—Ç–µ–∂–∞
        $formTitle.textContent = params.purpose;
      } else if (params.disable) {
        // Read-only —Ä–µ–∂–∏–º –±–µ–∑ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
        $formTitle.textContent = '–û–ø–ª–∞—Ç–∞';
      } else if (params.purpose) {
        // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º
        $formTitle.textContent = `–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã: ${params.purpose}`;
      } else {
        // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ—Ä–º—ã
        $formTitle.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã –æ–ø–ª–∞—Ç—ã';
      }
    }

    function applyDisabledMode() {
      // –î–µ–ª–∞–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
      $purpose.disabled = true;
      $account.disabled = true;
      $amount.disabled = true;
      $tinkoffMember.disabled = true;
      $transborder.disabled = true;
      
      // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
      document.getElementById('generate-btn').style.display = 'none';
      $copyLinkBtn.style.display = 'none';
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –±–∞–Ω–∫–æ–≤
      setTimeout(() => {
        generateBankButtons();
      }, 100);
      
      console.log('–ü—Ä–∏–º–µ–Ω–µ–Ω —Ä–µ–∂–∏–º —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è');
    }

    function generateBankButtons() {
      const acct = $account.value.trim();
      const amt = $amount.value.trim();
      if (!acct || !amt) return;

      // –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–Ω–æ–ø–∫–∏
      $banksWrap.innerHTML = '';

      const device = getDeviceInfo();

      Object.entries(BANKS).forEach(([code, cfg]) => {
        const btn = document.createElement('button');
        btn.className = `bank-btn ${cfg.css}`;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è —Å—Ö–µ–º–∞ –¥–ª—è —ç—Ç–æ–≥–æ –±–∞–Ω–∫–∞
        const preferredScheme = getPreferredScheme(code);
        const hasPreferredScheme = !!preferredScheme;
        const preferredIndicator = hasPreferredScheme ? '<div style="position:absolute;top:4px;right:4px;background:#00C851;color:white;border-radius:50%;width:16px;height:16px;font-size:10px;display:flex;align-items:center;justify-content:center;font-weight:bold;z-index:1;">‚úì</div>' : '';
        
        btn.innerHTML = `
          ${preferredIndicator}
          <object data="${cfg.icon}" type="image/svg+xml" style="width:100%;height:100%;pointer-events:none;"></object>
        `;
        
        if (hasPreferredScheme) {
          btn.title = `${cfg.label} (–µ—Å—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –¥–ª—è ${device.platform})`;
        }
        
        btn.addEventListener('click', () => handleBankClick(code));
        $banksWrap.appendChild(btn);
      });

      if (hasAnyPreferredSchemes()) {
        $clearBtn.style.display = 'block';
      } else {
        $clearBtn.style.display = 'none';
      }
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –∏–∑ URL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    fillFormFromUrl();

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updateDeviceHint();

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updateCopyLinkButton($account.value.trim(), $amount.value.trim());

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è URL (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ disabled —Ä–µ–∂–∏–º)
    const params = getUrlParams();
    if (!params.disable) {
      $purpose.addEventListener('input', updateUrlParams);
      $account.addEventListener('input', updateUrlParams);
      $amount.addEventListener('input', updateUrlParams);
      $tinkoffMember.addEventListener('change', updateUrlParams);
      $transborder.addEventListener('change', updateUrlParams);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏
    $copyLinkBtn.addEventListener('click', copyCurrentLink);

    document.getElementById('generate-btn').addEventListener('click', () => {
      const acct = $account.value.trim();
      const amt = $amount.value.trim();
      if (!acct || !amt) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞/–∫–∞—Ä—Ç—ã –∏ —Å—É–º–º—É');
        return;
      }

      // –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–Ω–æ–ø–∫–∏
      $banksWrap.innerHTML = '';

      const device = getDeviceInfo();

      Object.entries(BANKS).forEach(([code, cfg]) => {
        const btn = document.createElement('button');
        btn.className = `bank-btn ${cfg.css}`;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è —Å—Ö–µ–º–∞ –¥–ª—è —ç—Ç–æ–≥–æ –±–∞–Ω–∫–∞
        const preferredScheme = getPreferredScheme(code);
        const hasPreferredScheme = !!preferredScheme;
        const preferredIndicator = hasPreferredScheme ? '<div style="position:absolute;top:4px;right:4px;background:#00C851;color:white;border-radius:50%;width:16px;height:16px;font-size:10px;display:flex;align-items:center;justify-content:center;font-weight:bold;z-index:1;">‚úì</div>' : '';
        
        btn.innerHTML = `
          ${preferredIndicator}
          <object data="${cfg.icon}" type="image/svg+xml" style="width:100%;height:100%;pointer-events:none;"></object>
        `;
        
        if (hasPreferredScheme) {
          btn.title = `${cfg.label} (–µ—Å—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –¥–ª—è ${device.platform})`;
        }
        
        btn.addEventListener('click', () => handleBankClick(code));
        $banksWrap.appendChild(btn);
      });

      if (hasAnyPreferredSchemes()) {
        $clearBtn.style.display = 'block';
      } else {
        $clearBtn.style.display = 'none';
      }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
    $clearBtn.addEventListener('click', () => {
      const device = getDeviceInfo();
      let clearedCount = 0;
      
      // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å—Ö–µ–º—ã –¥–ª—è –≤—Å–µ—Ö –±–∞–Ω–∫–æ–≤
      Object.keys(BANKS).forEach(bank => {
        const cookieName = `preferred_scheme_${bank}_${device.platform}`;
        if (getCookie(cookieName)) {
          document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
          clearedCount++;
        }
      });
      
      console.log(`–û—á–∏—â–µ–Ω–æ ${clearedCount} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å—Ö–µ–º –¥–ª—è ${device.platform}`);
      $clearBtn.style.display = 'none';
      
      // –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –±–µ–∑ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
      const acct = $account.value.trim();
      const amt = $amount.value.trim();
      if (acct && amt) {
        document.getElementById('generate-btn').click();
      }
    });

    function handleBankClick(bank) {
      // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –°–±–µ—Ä –∏ —Å—Ç–æ–∏—Ç —á–µ–∫–±–æ–∫—Å ¬´—Ç—Ä–∞–Ω—Å–≥—Ä–∞–Ω–∏—á–Ω—ã–π¬ª ‚Äì –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–æ–¥ –±–∞–Ω–∫–∞
      const effectiveBank = bank === 'ru_sberbank' && $transborder.checked ? 'ru_sberbank_trans' : bank;

      const baseParams = {
        phone: $account.value.trim(),
        amount: $amount.value.trim(),
        bankMemberId: $tinkoffMember.value,
        isTransborder: $transborder.checked
      };

      const device = getDeviceInfo();
      
      // –î–ª—è desktop —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø—Ä–æ–±—É–µ–º —Å–Ω–∞—á–∞–ª–∞ HTTPS-—Å—Å—ã–ª–∫—É
      if (device.platform === 'desktop') {
        const desktopLink = generateDesktopLink({
          phone: baseParams.phone,
          bank: effectiveBank,
          isTransborder: baseParams.isTransborder
        });

        if (desktopLink) {
          console.log(`Desktop: –æ—Ç–∫—Ä—ã–≤–∞–µ–º HTTPS-—Å—Å—ã–ª–∫—É –¥–ª—è ${effectiveBank}:`, desktopLink);
          window.open(desktopLink, '_blank');
          return;
        } else {
          // –ï—Å–ª–∏ –Ω–µ—Ç desktop-—Å—Å—ã–ª–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º QR-–∫–æ–¥
          console.log(`Desktop: ${effectiveBank} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç web-—Ñ–æ—Ä–º—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º QR-–∫–æ–¥`);
          showQrCode(baseParams);
          return;
        }
      }

      // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º deeplink-–ª–æ–≥–∏–∫—É
      console.log(`–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${device.platform}, –±–∞–Ω–∫: ${effectiveBank}`);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –¥–ª—è —ç—Ç–æ–≥–æ –±–∞–Ω–∫–∞
      const preferredScheme = getPreferredScheme(effectiveBank);
      console.log(`–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –¥–ª—è ${effectiveBank}:`, preferredScheme);

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Å–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–∞–Ω–∫–∞
      const allLinks = generateDeepLinks({...baseParams, bank: effectiveBank});
      
      let orderedLinks = [];
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ö–µ–º–∞, –∏—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â—É—é —Å—Å—ã–ª–∫—É –∏ —Å—Ç–∞–≤–∏–º –µ—ë –ø–µ—Ä–≤–æ–π
      if (preferredScheme) {
        const preferredLink = findLinkByScheme(allLinks, preferredScheme);
        if (preferredLink) {
          orderedLinks.push(preferredLink);
          // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏, –∏—Å–∫–ª—é—á–∞—è –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—É—é
          const otherLinks = allLinks.filter(link => link !== preferredLink);
          orderedLinks = [...orderedLinks, ...otherLinks];
          console.log(`–ù–∞–π–¥–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –ø–æ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ–π —Å—Ö–µ–º–µ, –±—É–¥–µ—Ç –ø–æ–ø—Ä–æ–±–æ–≤–∞–Ω–∞ –ø–µ—Ä–≤–æ–π, –∑–∞—Ç–µ–º ${otherLinks.length} –¥—Ä—É–≥–∏—Ö —Å—Å—ã–ª–æ–∫`);
        } else {
          orderedLinks = allLinks;
          console.log(`–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ä–µ–¥–∏ —Ç–µ–∫—É—â–∏—Ö —Å—Å—ã–ª–æ–∫, –ø—Ä–æ–±—É–µ–º –≤—Å–µ ${allLinks.length} —Å—Å—ã–ª–æ–∫ –ø–æ –ø–æ—Ä—è–¥–∫—É`);
        }
      } else {
        orderedLinks = allLinks;
        console.log(`–ù–µ—Ç –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ–π —Å—Ö–µ–º—ã, –ø—Ä–æ–±—É–µ–º –≤—Å–µ ${allLinks.length} —Å—Å—ã–ª–æ–∫ –ø–æ –ø–æ—Ä—è–¥–∫—É`);
      }
      
      attemptLinks(orderedLinks, effectiveBank);
    }

    // –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–∂–¥—É—é —Å—Å—ã–ª–∫—É –ø–æ –æ—á–µ—Ä–µ–¥–∏, –ø–æ–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
    function attemptLinks(links, currentBank) {
      let idx = 0;
      let stopped = false;
      const delay = 1500; // –º—Å –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
      const device = getDeviceInfo();

      const tryNext = () => {
        if (stopped || idx >= links.length) {
          if (!stopped) {
            console.log('–í—Å–µ —Å—Å—ã–ª–∫–∏ –ø–µ—Ä–µ–ø—Ä–æ–±–æ–≤–∞–Ω—ã, –Ω–∏ –æ–¥–Ω–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞');
          }
          return;
        }
        
        const url = links[idx++];
        console.log(`–ü–æ–ø—ã—Ç–∫–∞ ${idx}/${links.length}:`, url);

        const startTime = Date.now();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É—Ö–æ–¥–∞ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—É—Å–ø–µ—à–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
        const handleVisibilityChange = () => {
          if (document.hidden || document.visibilityState === 'hidden') {
            console.log(`‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã–ª–æ—Å—å! –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ö–µ–º—É: ${url}`);
            savePreferredScheme(currentBank, url);
            stopped = true;
            cleanup();
          }
        };

        const handleBlur = () => {
          // –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ—Ç–µ—Ä—è–ª–∞ —Ñ–æ–∫—É—Å –±—ã—Å—Ç—Ä–æ –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞, –≤–µ—Ä–æ—è—Ç–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å
          if (Date.now() - startTime < 500) {
            console.log(`‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã–ª–æ—Å—å (blur)! –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ö–µ–º—É: ${url}`);
            savePreferredScheme(currentBank, url);
            stopped = true;
            cleanup();
          }
        };

        const cleanup = () => {
          document.removeEventListener('visibilitychange', handleVisibilityChange);
          window.removeEventListener('blur', handleBlur);
        };

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        document.addEventListener('visibilitychange', handleVisibilityChange);
        window.addEventListener('blur', handleBlur);

        if (device.isIOS) {
          window.location = url;
        } else {
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = url;
          document.body.appendChild(iframe);
          setTimeout(() => iframe.remove(), delay - 100);
        }

        // –£–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è –∏ –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â—É—é —Å—Å—ã–ª–∫—É
        setTimeout(() => {
          cleanup();
          if (!stopped) {
            tryNext();
          }
        }, delay);
      };

      tryNext();
    }
  </script>
</body>
</html> 